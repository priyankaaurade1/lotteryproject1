{% extends 'lottery/base_adminpanel.html' %}
{% block content %}
<style>
  /* Remove default container padding that can shrink table on mobile */
  .container-fluid, .container {
    padding: 0;
    margin: 0;
    max-width: 100%;
  }

  h2.history-title {
    margin: 10px 0;
    padding: 0;
    font-weight: bold;
    text-align: center;
  }

  #historyForm {
    font-weight: bold;
    font-size: 1rem;
    overflow-x: auto;
    white-space: nowrap;
    display: flex;
    gap: 0.75rem;
    padding: 5px;
    -webkit-overflow-scrolling: touch;
  }

  #historyForm .form-control,
  #historyForm .form-select {
    min-width: 140px;
  }

  @media (max-width: 768px) {
    #historyForm {
      font-size: 0.9rem;
      padding: 3px;
    }

    #historyForm .form-control,
    #historyForm .form-select {
      min-width: 120px;
      font-size: 0.85rem;
    }
  }

  .table-responsive {
    margin: 0;
    padding: 0;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .table {
    margin: 0;
    width: auto;
  }

  td {
    padding: 4px;
    text-align: center;
    font-weight: bold;
    font-size: 0.95rem;
    white-space: nowrap;
  }

  @media (max-width: 768px) {
    td {
      font-size: 0.85rem;
      padding: 2px;
    }
  }
</style>

<div class="container-fluid">
  <h2 class="history-title">All Previous Results</h2>

  <form method="post" id="historyForm">
    {% csrf_token %}
    <div>
      <label class="mb-0">Time:</label>
      <span id="currentTime">--:--:--</span>
    </div>
    <div>
      <label class="mb-0">Date:</label>
      <input type="date" name="date" value="{{ selected_date }}" class="autoSubmit form-control form-control-sm">
    </div>
    <div>
      <label class="mb-0">Slot:</label>
      <select name="time" class="autoSubmit form-select form-select-sm">
        <option {% if not selected_time or selected_time == "All Times" %}selected{% endif %}>All Times</option>
        {% for slot in time_slots %}
          <option value="{{ slot }}" {% if slot == selected_time %}selected{% endif %}>{{ slot }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="mb-0">Left:</label>
      <span id="nextDraw">--:--:--</span>
    </div>
    <input type="hidden" id="nextDrawTime" value="{{ next_draw_time_str }}">
  </form>

  {% if no_results %}
    <div class="alert alert-warning text-center mt-2">
      No Record found
    </div>
  {% endif %}

  <div class="scrollable-container">
    {% for group in result_tables %}
      <h5 class="text-center mt-2 mb-1" style="font-size: 1rem;">{{ group.date }} - {{ group.time_slot }}</h5>
      <div class="table-responsive">
        <table class="table table-bordered text-center mb-0">
          {% for row in group.table %}
            <tr>
              {% for cell in row %}
                <td style="background-color:
                  {% if forloop.counter0 == 0 %}#FFD700
                  {% elif forloop.counter0 == 1 %}#DDA0DD
                  {% elif forloop.counter0 == 2 %}#90EE90
                  {% elif forloop.counter0 == 3 %}#FFB6C1
                  {% elif forloop.counter0 == 4 %}#CD5C5C
                  {% elif forloop.counter0 == 5 %}#F5DEB3
                  {% elif forloop.counter0 == 6 %}#ADD8E6
                  {% elif forloop.counter0 == 7 %}#FFC0CB
                  {% elif forloop.counter0 == 8 %}#87CEEB
                  {% elif forloop.counter0 == 9 %}#FFA07A
                  {% endif %};">
                  {% if cell %}
                    {{ cell.number }}
                  {% else %}
                    ----
                  {% endif %}
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        </table>
      </div>
    {% endfor %}
  </div>
</div>

<script>
function updateTimes() {
  const now = new Date();
  const kolkataTime = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));
  const currentTimeElem = document.getElementById("currentTime");
  if (currentTimeElem) {
    const hours = kolkataTime.getHours();
    const minutes = kolkataTime.getMinutes();
    const seconds = kolkataTime.getSeconds();
    const hour12 = hours % 12 || 12;
    const ampm = hours >= 12 ? "PM" : "AM";
    currentTimeElem.textContent = `${String(hour12).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')} ${ampm}`;
  }

  const nextDrawInput = document.getElementById("nextDrawTime");
  const nextDrawElem = document.getElementById("nextDraw");
  if (!nextDrawInput || !nextDrawElem) return;

  let nextDraw = new Date(nextDrawInput.value);
  let diff = nextDraw - kolkataTime;

  if (diff <= 0) {
    const tomorrow9am = new Date(kolkataTime);
    tomorrow9am.setDate(tomorrow9am.getDate() + 1);
    tomorrow9am.setHours(9, 0, 0, 0);
    diff = tomorrow9am - kolkataTime;
    location.reload();
    return;
  }

  if (diff > 0) {
    const totalSeconds = Math.floor(diff / 1000);
    const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
    const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
    const s = String(totalSeconds % 60).padStart(2, '0');
    nextDrawElem.textContent = `${h}:${m}:${s}`;
  } else {
    nextDrawElem.textContent = "00:00:00";
  }
}
setInterval(updateTimes, 1000);
updateTimes();
</script>

<script>
document.querySelectorAll(".autoSubmit").forEach(el => {
  el.addEventListener("change", () => {
    document.getElementById("historyForm").submit();
  });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  let nextDrawTimeStr = document.getElementById('nextDrawTime')?.value;

  async function pollNextDrawTime() {
    try {
      const response = await fetch("{% url 'next_draw_time_api' %}");
      const data = await response.json();
      if (!data.next_draw_time_str) return;

      if (data.next_draw_time_str !== nextDrawTimeStr) {
        location.reload();
        return;
      }
      updateCountdownDisplay(data.total_seconds);
    } catch (error) {
      console.error('Error polling next draw time:', error);
    }
  }

  function updateCountdownDisplay(totalSeconds) {
    const countdownEl = document.getElementById('nextDraw');
    if (!countdownEl) return;

    if (totalSeconds <= 0) {
      location.reload();
      return;
    }

    const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
    const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
    const s = String(totalSeconds % 60).padStart(2, '0');
    countdownEl.textContent = `${h}:${m}:${s}`;
  }

  setInterval(pollNextDrawTime, 5000);
  pollNextDrawTime();
});
</script>
{% endblock %}
