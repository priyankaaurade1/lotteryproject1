{% extends 'lottery/base_adminpanel.html' %}

{% block content %}
<style>
input[type="text"] {
  font-weight: bold;
  text-align: center;
}

td {
  padding: 4px;
  vertical-align: middle !important;
}

button {
  padding: 2px 6px;
  font-size: 12px;
}
</style>
{% if messages %}
  <div class="container">
    {% for message in messages %}
      <div class="alert alert-success text-center" role="alert">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}

<h2 class="text-center">
  Edit Results
</h2>

<div style="font-size: 25px; font-weight: 500; text-align: center;">
  <span style="margin-right: 20px;">Time: <span id="currentTime">--:--:--</span></span>
  <span style="margin-right: 20px;">Date: <span>{{ formatted_date }}</span></span>
  <span style="margin-right: 20px;">Slot: <span>{{ time_slot }}</span></span>
  <span>Next Draw In: <span id="nextDraw">--:--:--</span></span>
</div>
<input type="hidden" id="nextDrawTime" value="{{ next_draw_time_str }}">

<br>
<form method="POST" action="{% url 'update_all_results' %}">
  {% csrf_token %}
  <table class="table table-bordered text-center">
    {% for row in table %}
    <tr>
      {% for cell in row %}
      <td style="background-color:
        {% if forloop.counter0 == 0 %}#FFD700
        {% elif forloop.counter0 == 1 %}#DDA0DD
        {% elif forloop.counter0 == 2 %}#90EE90
        {% elif forloop.counter0 == 3 %}#FFB6C1
        {% elif forloop.counter0 == 4 %}#CD5C5C
        {% elif forloop.counter0 == 5 %}#F5DEB3
        {% elif forloop.counter0 == 6 %}#ADD8E6
        {% elif forloop.counter0 == 7 %}#FFC0CB
        {% elif forloop.counter0 == 8 %}#87CEEB
        {% elif forloop.counter0 == 9 %}#FFA07A
        {% endif %};">

        {% if cell %}
          <div class="d-flex justify-content-center align-items-center">
            <strong>{{ cell.first_two_digits }}</strong>
            {% if cell.is_editable %}
              <input type="hidden" name="ids" value="{{ cell.pk }}">
              <input type="text" name="last_two_{{ cell.pk }}" value="{{ cell.last_two_digits }}" maxlength="2" size="2" class="form-control form-control-sm ms-1" style="width:50px;" />
            {% else %}
              <span class="ms-1">{{ cell.last_two_digits }}</span>
            {% endif %}
          </div>
        {% else %}
          ----
        {% endif %}
      </td>
      {% endfor %}
    </tr>
    {% endfor %}
  </table>

  <div class="text-center mt-3">
    <button type="submit" class="btn btn-primary">Update</button>
  </div>
</form>
<script>
    function updateTimes() {
        const now = new Date();
        const kolkataTime = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));

        let hour = kolkataTime.getHours();
        const minute = kolkataTime.getMinutes();
        const second = kolkataTime.getSeconds();

        let hour12 = hour % 12;
        hour12 = hour12 === 0 ? 12 : hour12;

        const formattedHour = String(hour12).padStart(2, '0');
        const formattedMinute = String(minute).padStart(2, '0');
        const formattedSecond = String(second).padStart(2, '0');

        const formattedTime = `${formattedHour}:${formattedMinute}:${formattedSecond}`;
        document.getElementById("currentTime").textContent = formattedTime;

        // Countdown logic
        const nextDrawStr = document.getElementById("nextDrawTime").value;
        const nextDraw = new Date(nextDrawStr);
        const diff = nextDraw - kolkataTime;

        if (diff > 0) {
            const totalSeconds = Math.floor(diff / 1000);
            const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
            const seconds = String(totalSeconds % 60).padStart(2, '0');
            document.getElementById("nextDraw").textContent = `${hours}:${minutes}:${seconds}`;
        } else {
            location.reload();
        }
    }

    setInterval(updateTimes, 1000);
    updateTimes();
  </script>
{% endblock %}
